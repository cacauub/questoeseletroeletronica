<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elaboração de Questões - Curso Téc. Eletroeletrônica - Base SAEP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .footer {
            font-size: 7pt;
            text-align: center;
            padding: 20px;
            color: #9ca3af; /* gray-400 */
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-content, #printable-content * {
                visibility: visible;
            }
            #printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
            .footer-print {
                position: fixed;
                bottom: 0;
                width: 100%;
                font-size: 7pt;
                text-align: center;
                color: #000;
                visibility: visible;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl mx-auto">
            
            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Elaboração de Questões</h1>
                <p class="text-slate-600 mt-2">Curso Téc. Eletroeletrônica - Base SAEP</p>
            </header>

            <!-- Form Container -->
            <div id="form-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg transition-all duration-500">
                <form id="question-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Unidade Curricular -->
                        <div class="md:col-span-2">
                            <label for="unidade-curricular" class="block text-sm font-medium text-slate-700 mb-2">Unidade Curricular</label>
                            <select id="unidade-curricular" name="unidade-curricular" class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-white focus:border-blue-500 transition">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>

                        <!-- Número de Questões -->
                        <div>
                            <label for="num-questoes" class="block text-sm font-medium text-slate-700 mb-2">Número de Questões</label>
                            <input type="number" id="num-questoes" name="num-questoes" value="5" min="1" max="20" class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-white focus:border-blue-500 transition">
                        </div>

                        <!-- Número de Opções -->
                        <div>
                            <label for="num-opcoes" class="block text-sm font-medium text-slate-700 mb-2">Opções por Questão</label>
                            <input type="number" id="num-opcoes" name="num-opcoes" value="4" min="2" max="6" class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-white focus:border-blue-500 transition">
                        </div>
                    </div>

                    <!-- Contextualização Checkbox -->
                    <div class="mt-6 flex items-center">
                        <input id="contextualizar" name="contextualizar" type="checkbox" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                        <label for="contextualizar" class="ml-3 block text-sm font-medium text-slate-700">Gerar questões mais contextualizadas</h>
                    </div>

                    <!-- Generate Button -->
                    <div class="mt-8">
                        <button type="submit" id="generate-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                            Gerar Questões
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-container" class="text-center py-12 hidden">
                <div role="status" class="flex justify-center items-center flex-col">
                    <svg aria-hidden="true" class="w-12 h-12 mb-4 text-slate-200 animate-spin dark:text-slate-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                    </svg>
                    <span class="text-slate-600 text-lg">Gerando questões... Por favor, aguarde.</span>
                </div>
            </div>

            <!-- Results Container -->
            <div id="results-container" class="hidden mt-8">
                <div id="printable-content" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-8">
                    <!-- Questions will be injected here -->
                </div>
                 <div id="actions-container" class="mt-6 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <div class="text-center w-full sm:w-auto">
                        <p class="text-slate-700 font-medium mb-2">As questões estão como você queria?</p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button id="regenerate-btn" class="py-2 px-6 border border-slate-300 rounded-lg shadow-sm text-base font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition">
                                Gerar Novamente
                            </button>
                            <button id="export-btn" class="py-2 px-6 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                                Exportar para Word
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message Box -->
            <div id="error-box" class="hidden mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Ocorreu um erro!</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>

        </div>
        <footer class="footer">Criado por Antonio Carlos Padovani</footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const formContainer = document.getElementById('form-container');
            const questionForm = document.getElementById('question-form');
            const unidadeCurricularSelect = document.getElementById('unidade-curricular');
            const numQuestoesInput = document.getElementById('num-questoes');
            const numOpcoesInput = document.getElementById('num-opcoes');
            const contextualizarCheckbox = document.getElementById('contextualizar');
            const loadingContainer = document.getElementById('loading-container');
            const resultsContainer = document.getElementById('results-container');
            const printableContent = document.getElementById('printable-content');
            const actionsContainer = document.getElementById('actions-container');
            const regenerateBtn = document.getElementById('regenerate-btn');
            const exportBtn = document.getElementById('export-btn');
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            // --- Data ---
            const unidadesCurriculares = [
                "Fundamentos da Eletroeletrônica",
                "Instalação de Sistemas Elétricos Industriais",
                "Instalação de Sistemas Elétricos Prediais",
                "Projetos de Acionamento e Controle Industriais",
                "Projetos de Circuitos Eletrônicos Industriais",
                "Projetos de Instalações Elétricas Prediais",
                "Instalação de Sistemas Eletroeletrônicos Industriais",
                "Manutenção de Sistemas Elétricos Industriais",
                "Manutenção de Sistemas Elétricos Prediais",
                "Manutenção de Sistemas Eletrônicos Industriais",
                "Gestão da Instalação de Sistemas Eletroeletrônicos",
                "Gestão da Manutenção de Sistemas Eletroeletrônicos"
            ];

            // --- Initial Setup ---
            function initializeApp() {
                // Populate the dropdown
                unidadesCurriculares.forEach(uc => {
                    const option = document.createElement('option');
                    option.value = uc;
                    option.textContent = uc;
                    unidadeCurricularSelect.appendChild(option);
                });

                // Add event listeners
                questionForm.addEventListener('submit', handleFormSubmit);
                regenerateBtn.addEventListener('click', handleFormSubmit);
                exportBtn.addEventListener('click', exportToWord);
            }

            // --- Event Handlers ---
            function handleFormSubmit(event) {
                event.preventDefault();
                generateQuestions();
            }
            
            function displayError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
                loadingContainer.classList.add('hidden');
                formContainer.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            }

            // --- Core Logic ---
            async function generateQuestions() {
                // 1. Get form data
                const unidade = unidadeCurricularSelect.value;
                const numQuestoes = numQuestoesInput.value;
                const numOpcoes = numOpcoesInput.value;
                const isContextualized = contextualizarCheckbox.checked;

                // 2. Update UI to loading state
                formContainer.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                errorBox.classList.add('hidden');
                loadingContainer.classList.remove('hidden');
                printableContent.innerHTML = ''; // Clear previous results

                // 3. Construct the prompt for the Gemini API
                let prompt = `Aja como um professor especialista em Eletroeletrônica, com profundo conhecimento pedagógico da Metodologia SENAI de Educação Profissional (MSEP) e na matriz de avaliação SAEP. Seu objetivo é criar questões para o curso Técnico em Eletroeletrônica.
                
                As questões devem ser baseadas em **situações-problema** e **estudos de caso** realistas, conforme preconiza a MSEP, para avaliar a aplicação prática do conhecimento, não apenas a memorização. Utilize fontes técnicas confiáveis e atualizadas da área de eletroeletrônica para garantir a precisão e relevância do conteúdo.

                Para a unidade curricular **"${unidade}"**, gere **${numQuestoes}** questões.
                
                Cada questão deve ter **${numOpcoes}** opções de resposta.
                
                ${isContextualized ? "Elabore enunciados e opções de resposta com uma contextualização rica e detalhada, simulando um cenário profissional complexo e realista." : ""}

                Para cada questão, forneça o texto da questão, as opções, a resposta correta (que deve ser uma das opções) e uma breve explicação do porquê a resposta está correta.

                Retorne a resposta estritamente no formato JSON, seguindo o schema fornecido.`;

                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "question_text": { "type": "STRING", "description": "O enunciado da questão, apresentando uma situação-problema." },
                            "options": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" },
                                "description": `Uma lista com ${numOpcoes} opções de resposta.`
                            },
                            "correct_answer": { "type": "STRING", "description": "O texto exato da opção correta." },
                            "explanation": { "type": "STRING", "description": "Uma explicação clara e concisa do porquê a resposta é correta." }
                        },
                        required: ["question_text", "options", "correct_answer", "explanation"]
                    }
                };

                // 4. Call the Gemini API
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    };
                    const apiKey = ""; // API key will be injected by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const questions = JSON.parse(jsonText);
                        renderQuestions(questions);

                    } else {
                         throw new Error("A resposta da API está vazia ou em formato inesperado. Tente novamente.");
                    }

                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    displayError(`Falha ao gerar as questões. Detalhes: ${error.message}`);
                }
            }

            // --- UI Rendering ---
            function renderQuestions(questions) {
                printableContent.innerHTML = ''; // Clear any previous content
                questions.forEach((q, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'p-6 border border-slate-200 rounded-xl';
                    
                    let optionsHtml = '<ul class="space-y-3 mt-4 list-none pl-0">';
                    q.options.forEach(option => {
                        const isCorrect = (option === q.correct_answer);
                        optionsHtml += `<li class="flex items-start p-3 rounded-md ${isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-slate-50'}">
                            <span class="text-slate-700">${option}</span>
                        </li>`;
                    });
                    optionsHtml += '</ul>';

                    questionElement.innerHTML = `
                        <h3 class="text-lg font-semibold text-slate-800">Questão ${index + 1}</h3>
                        <p class="mt-2 text-slate-700">${q.question_text}</p>
                        ${optionsHtml}
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <p class="text-sm text-slate-600">
                                <strong class="text-slate-800">Resposta Correta:</strong> 
                                <em class="italic">${q.correct_answer}</em>
                            </p>
                            <p class="text-sm text-slate-600 mt-2">
                                <strong class="text-slate-800">Justificativa:</strong> ${q.explanation}
                            </p>
                        </div>
                    `;
                    printableContent.appendChild(questionElement);
                });

                // Update UI to show results
                loadingContainer.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                actionsContainer.classList.remove('hidden');
            }

            // --- Utility Functions ---
            function exportToWord() {
                const header = `<h1 style="font-size: 24px; font-weight: bold; text-align: center;">Questões - ${unidadeCurricularSelect.value}</h1><br>`;
                const footer = `<p style="font-size: 7pt; text-align: center; color: #888;">Criado por Antonio Carlos Padovani</p>`;
                
                // Use a clone to avoid modifying the displayed content
                const contentToExport = printableContent.cloneNode(true);
                
                // Add footer to each question block for better placement in Word
                contentToExport.querySelectorAll('.p-6.border').forEach(block => {
                    const footerElement = document.createElement('div');
                    footerElement.innerHTML = `<br><p style="font-size: 7pt; text-align: right;">Criado por Antonio Carlos Padovani</p>`;
                    block.appendChild(footerElement);
                });

                const content = header + contentToExport.innerHTML;

                // Convert HTML to DOCX format
                var converted = htmlDocx.asBlob(content, {
                    orientation: 'portrait',
                    margins: {
                        top: 720, // 1 inch
                        bottom: 720,
                        left: 720,
                        right: 720,
                    }
                });

                // Save the file
                saveAs(converted, `Questoes_${unidadeCurricularSelect.value.replace(/ /g, '_')}.docx`);
            }

            // --- Start the app ---
            initializeApp();
        });
    </script>

</body>
</html>
